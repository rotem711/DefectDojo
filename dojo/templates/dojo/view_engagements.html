{% extends "base.html" %}
{% load humanize %}
{% load display_tags %}
{% load static from staticfiles %}
{% block add_styles %}
    .graph {min-height: 158px;}
    h3 { margin-top: 5px; margin-bottom: 5px; font-size: 20px; line-height: 22px;}
{% endblock %}
{% block content %}
    <div class="row">
        {% if user.is_staff or authorized %}
          <div class="col-md-12">
                <div class="panel panel-default table-responsive">
                    <div class="panel-heading">
                        <h4> Active Engagements <a title="Add New Engagement" class="pull-right btn btn-sm btn-primary"
                                                   href="{% url 'new_eng_for_prod' prod.id %}"><span
                                class="fa fa-plus"></span> </a></h4>
                    </div>
                    {% if engs %}
                        <table class="tablesorter-bootstrap table table-condensed table-striped table-hover">
                            <thead>
                            <tr>
                                <th>Name</th>
                                <th></th>
                                <th>Lead</th>
                                <th>Date</th>
                                <th>Length</th>
                                <th>Tests</th>
                                <th>Findings</th>
                                <th>Duplicate</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for eng in engs %}
                                <tr>
                                <td><a href="{% url 'view_engagement' eng.id %}">{{ eng.name | default:"N/A" }}</a>
                                {% if eng.tags %}
                                    <sup>
                                        {% for tag in eng.tags %}
                                        <a title="Search {{ tag }}" class="tag-label tag-color" href="{% url 'simple_search' %}?query={{ tag }}">{{ tag }}</a>
                                        {% endfor %}
                                    </sup>
                                {% endif %}
                                </td>
                                <td>
                                <ul>
                                 <li class="dropdown" style="list-style:none;">
                                       <a href="#" class="dropdown-toggle" data-toggle="dropdown">&nbsp;<b class="fa fa-ellipsis-v"></b>&nbsp;</a>
                                       <ul class="dropdown-menu">
                                         <li>
                                           <a class="" href="{% url 'view_engagement' eng.id %}">
                                             View
                                         </li>
                                         <li>
                                           </a>
                                           <a class="" href="{% url 'close_engagement' eng.id %}">
                                             Close
                                           </a>
                                         </li>
                                         <li>
                                           <a class="" href="{% url 'edit_engagement' eng.id %}">
                                             Edit
                                           </a>
                                        </li>
                                        <li class="divider"></li>
                                        <li>
                                           <a class="" href="{% url 'delete_engagement' eng.id %}">
                                             Delete
                                           </a>
                                        </li>
                                       </ul>
                                     </li>
                                 </ul>
                                </td>
                                <td>
                                  {% if eng.lead.get_full_name and eng.lead.get_full_name.strip %}
                                      {{ eng.lead.get_full_name }}
                                  {% else %}
                                      {{ eng.lead }}
                                  {% endif %}
                                </td>
                                <td>{{ eng.target_start }} - {{ eng.target_end }}</td>
                                <td>{{ eng.target_start|datediff_time:eng.target_end }}
                                  {% if eng.target_end|overdue %}
                                  <sup>
                                    <div class="tag-label warning-color">
                                      {{ eng.target_end|overdue }} overdue
                                    </div>
                                  </sup>
                                  {% endif %}
                                </td>
                                <td>{{ eng.test_set.all|length }}</td>
                                <td>{{ eng.test_set.all|count_findings_eng|finding_status:False|length }}</td>
                                <td>{{ eng.test_set.all|count_findings_eng|finding_status:True|length }}</td>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="panel-body">
                            <p class="text-center">No active engagements found.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
        {% if user.is_staff and i_engs %}
            <div class="col-md-12">
              <div class="clearfix">
                  {% include "dojo/paging_snippet.html" with page=i_engs page_size=True %}
              </div>
                <div class="panel panel-default table-responsive">
                    <div class="panel-heading">
                        <h4> Closed Engagements </h4>
                    </div>
                    <table class="tablesorter-bootstrap table table-condensed table-striped table-hover">
                        <thead>
                        <tr>
                          <th>Name</th>
                          <th></th>
                          <th>Lead</th>
                          <th>Date</th>
                          <th>Length</th>
                          <th>Tests</th>
                          <th>Findings</th>
                          <th>Duplicate</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for eng in i_engs %}
                            <tr>
                            <td><a href="{% url 'view_engagement' eng.id %}">{{ eng.name | default:"N/A" }}</a></td>
                            <td>
                            <ul>
                             <li class="dropdown" style="list-style:none;">
                                   <a href="#" class="dropdown-toggle" data-toggle="dropdown">&nbsp;<b class="fa fa-ellipsis-v"></b>&nbsp;</a>
                                   <ul class="dropdown-menu">
                                     <li>
                                       <a class="" href="{% url 'view_engagement' eng.id %}">
                                         View
                                     </li>
                                     <li>
                                       </a>
                                       <a class="" href="{% url 'reopen_engagement' eng.id %}">
                                         Reopen
                                       </a>
                                     </li>
                                     <li>
                                       <a class="" href="{% url 'edit_engagement' eng.id %}">
                                         Edit
                                       </a>
                                    </li>
                                    <li class="divider"></li>
                                    <li>
                                       <a class="" href="{% url 'delete_engagement' eng.id %}">
                                         Delete
                                       </a>
                                    </li>
                                   </ul>
                                </li>
                            </ul>
                            </td>
                            <td>
                              {% if eng.lead.get_full_name and eng.lead.get_full_name.strip %}
                                  {{ eng.lead.get_full_name }}
                              {% else %}
                                  {{ eng.lead }}
                              {% endif %}
                            </td>
                            <td>{{ eng.target_start }} - {{ eng.target_end }}</td>
                            <td>{{ eng.target_start|datediff_time:eng.target_end }}</td>
                            <td>{{ eng.test_set.all|length }}</td>
                            <td>{{ eng.test_set.all|count_findings_eng|finding_status:False|length }}</td>
                            <td>{{ eng.test_set.all|count_findings_eng|finding_status:True|length }}</td>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="clearfix">
                    {% include "dojo/paging_snippet.html" with page=i_engs page_size=True %}
                </div>
            </div>
        {% endif %}


    </div>

{% endblock %}
{% block postscript %}
    <script type="text/javascript" src="{% static "jquery-highlight/jquery.highlight.js" %}"></script>
    <script type="text/javascript">
        $(function () {
            //Ensures dropdown has proper zindex
            $('.table-responsive').on('show.bs.dropdown', function () {
              $('.table-responsive').css( "overflow", "inherit" );
            });
            if (document.referrer.indexOf('simple_search') > 0) {
                var terms = '';
                if ($.cookie('highlight')) {
                    terms = $.cookie('highlight').split(' ');

                    for (var i = 0; i < terms.length; i++) {
                        $('body').highlight(terms[i]);
                    }
                }

                $('input#simple_search').val(terms);
            }
          });
    </script>
{% endblock %}
