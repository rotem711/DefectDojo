sudo: required

language: python

install: true

env:
  #DockerHub
  - secure: "JfxzNdNlnmS8cHszC+QfxgRNNhzBbSkfimXgDvtk7/SsTIO4D3Oa591v6OMiG+7SgWlqnqb5VvMk5rCPD2aQhmx+Hl1YxnuVW8xnbVqrnqvS5qsP3WQ/8Diq5j2XM5EMn8bNd507g9ZPSD3QGV8MT3Q2uKX3K2ARdnxvGmnUAPygq0b/BGZjZQ0HJTW2r09L7Dy4EORGyeWQkTsxF4wJRo/B6Yl6Yzbm8r6U0eyH4djNw/tzVkQrX++EZ+m/ouO3/NMNwQ9ywKwwkZZAm1mTjd+LKJEiqdvw2kGBJQSAuHw402HT3TyEkB4DdQ3BTUCWvTy2YKYj6WUn/1lDqDfatUj1PyKYjr03cg/Es1UDsB9tiLYWTvhF+wIww3SYkL3GZkrpkH1HvALVND3aVTArRt0xvd36WcrMycQ6Juo6D4W8T9PQmnClngUMlvCHWERB4NhDDVtxv9YiuNrU1cZC2GoGNBHy62vGZYwnh246kaD0qvLcwSxbBwef7O9Zz+4NKpj6ubsRI0hjhg1MNBdc93ZKPhsuVGIqacR63iK9A5c3JM2LEZDYx9Uw0jLLzb/szLO5hdJGrS7xsb7v9zOzLgVKjCGjM6DrIt/3pP1wd9l83Pi4Q2YRX5vOXIROJ4VKsffeo1L81Nr8cb3K6dGlbhkQqAwJZ3961Z+euQ6kYqk="
  - secure: "Ohx+WXYkBXEntk0vNMmDFCZccML5MnmA5HW3phDWv6UanBchAWghC632wIGn0sUQxnDs78TiCWhSMdcCn/7VlopEWdmwpwIF/a8dNwHo3AyQZx5qAz1eHQGbS5DqKZ2JF2xuvb8+fFvPJqPU4q8XZYy7zWG1i0zDF2sw4HCBcWoeH1by7YkNb6YkIuby5Hvrhcayi9jamovddH7AeAGkxTKMz1X0TwxWyB0M1zW9wHuVUn/g7Vb7NQR+DlRr2QshCZePWmiKFHGMT2Y2bwcYuCj6f2HvClUKRIXdM9Fm57N5eCccA/0BZdeNW1YnLL2jlWA8uxzcQomSmW0+m3Yaqq3KnLkO0JM0GtRrTVxDoZvTczJmBC8RW0E6sVMr9TaRBUogfntEPumBMuibCKj8YcnyYxAUN6Cz4hQqE7iDkhHB7K1bOFyrlmFqBZp2pszit9Ref15D885pKKLUkvHtxG4ldxUWU8N0pJKdraBIAVFn8RGlbBd60nYKTN2SHx8xXni2RKAsswXWCxNfXmCUMFKECaIs2d7cQtAouporpDtafSfGdyGhTCSTyIS6b9k/lfTittJlepwxKYvcwuuRU7FEgG3j1tXCghKoQdX9QbNKI41bRyQkdE7VciNULrkTJqQFFGgNQJIFmXN3pLWQjYazJR4L4FBNytW+hBxtspo="
  - secure: "WNSg0OujHd9PR//fCsycCVLrE7Kohyg2Lx58fYtprLT125ZzNCpVyXpN2cfy+ahhTmViR+JD8sUJRVAhCFP1sdeVG+zGRxf6sLJZjtppnFnWHytTcaBn8EYAR5LPRfq+QvkA4bszgGt/7d4Jc0ejIIJGxpTpqw9K7fAZbgLlVBLsJtIy05WX8YgtSSlHs/l2m+k2mFPhCixs4HL8zJGXs6dFPHkJugfKvpDPCePY9xATUrmTywxXFN3Lh0a80HZBQpF/usrKWzjBx366vkYslxDqi7JbaNgRFqQdFj6ax3aynCERWoBLIPOT604qqdlFvujECT5zg6D0G/fC8WMf8aJP25PDx1AJIftVKwtKYsTPrdgclX0UE+NnUzhR1DU6xNN6DHcBbuCu3lOxssguhF2+8US3qgf1vqJKOvIH2bYWlP8x9Rny78xA7JiHHE5z6m9ZcIUEQ9qxvl1+PVU8O7ftupq6fTRNob3m53jl3rcrfTD/VR3s0KXtYs5D0b4VSElIVBcbTYcTEbTMyK6hDcNl/OZvurL+rYfg/uutwwKOx49NOeKOrihVrW1p6VywVLM5viPEzNu2cRL2vTvxNcb21SVpU81Kt52wOgyVXETkt+FcT7YKXwwaxLTT3s/SJXsQXIRYmVfQHkwmhY9lt/3vx3mSzJigY+qN+VLTGxI="
  - COMMIT=${TRAVIS_COMMIT::8}
services:
  - docker

before_script:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start

before_install:
  ## Docker Build
  - export DOJO_ADMIN_USER=test_user
  - export DOJO_ADMIN_PASSWORD=test_password
  - export REPO=appsecpipeline/django-DefectDojo
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  - docker build -f Dockerfile -t $REPO:$COMMIT .
  - docker run -e DOJO_ADMIN_USER=$DOJO_ADMIN_USER -e DOJO_ADMIN_PASSWORD=$DOJO_ADMIN_PASSWORD --name dojo -d -p 127.0.0.1:8000:8000 $REPO bash /django-DefectDojo/docker/docker-startup.bash
  - docker logs dojo
  - docker run -d --name zap --link dojo -p 127.0.0.1:8080:8080 -i owasp/zap2docker-stable zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.disablekey=true
  - docker ps -a
  - docker logs dojo
  - echo "Checking to see if dojo is running"
  - curl http://localhost:8000/login?next=/
  ## Selenium and ZAP requirements
  - pip install selenium==2.9.0
  - pip install requests
  - pip install python-owasp-zap-v2.4
  - pip install prettytable
  - pip install bandit

after_success:
  ## Run the SRC:CLR Scan
  - curl -sSL https://download.sourceclear.com/ci.sh | bash
  ## Run Bandit python static code
  - bandit -r * -x venv,tests,ansible
  ## Run Docker Bench for Security
  - git clone https://github.com/docker/docker-bench-security.git
  - cd docker-bench-security
  - sh docker-bench-security.sh
  #Push to docker repo
  - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
  - docker tag $REPO:$COMMIT $REPO:$TAG
  - docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
  - docker push $REPO

script:
  - python tests/check_status.py -v && python tests/smoke_test.py && python tests/zap.py

addons:
  firefox: "45.0"
