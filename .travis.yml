sudo: required

language: python

install: true

env:
  - COMMIT=${TRAVIS_COMMIT::8}
services:
  - docker

before_script:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start

before_install:
  ## Docker Build
  - export DOJO_ADMIN_USER=test_user
  - export DOJO_ADMIN_PASSWORD=test_password
  - export REPO=appsecpipeline/django-defectdojo
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  - docker build -t $REPO:${TRAVIS_COMMIT::8} .
  - docker run -e DOJO_ADMIN_USER=$DOJO_ADMIN_USER -e DOJO_ADMIN_PASSWORD=$DOJO_ADMIN_PASSWORD --name dojo -d -p 127.0.0.1:8000:8000 $REPO:${TRAVIS_COMMIT::8} bash /django-DefectDojo/docker/docker-startup.bash
  - docker logs dojo
  - docker run -d --name zap --link dojo -p 127.0.0.1:8080:8080 -i owasp/zap2docker-stable zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.disablekey=true
  - docker ps -a
  - docker logs dojo
  - echo "Checking to see if dojo is running"
  - curl http://localhost:8000/login?next=/
  ## Selenium and ZAP requirements
  - pip install selenium==2.53.6
  - pip install requests
  - pip install python-owasp-zap-v2.4
  - pip install prettytable
  - pip install bandit

after_success:
  ## Run the SRC:CLR Scan
  - curl -sSL https://download.sourceclear.com/ci.sh | bash
  ## Run Bandit python static code
  - bandit -r * -x venv,tests,ansible
  ## Run Docker Bench for Security
  - git clone https://github.com/docker/docker-bench-security.git
  - cd docker-bench-security
  - sh docker-bench-security.sh
  #Push to docker repo
  - cd ../
  - sh docker/dojo-container-build-push.bash

script:
  - python tests/check_status.py -v && python tests/smoke_test.py && python tests/zap.py

notifications:
  slack: "V6aYEfl754hSFyAHbFhOitpzbusmfTVWBlthhj6ZspvIsKGq6/W8SezkAuvpDLEruc8fnrtt+8iQZvj0RbCgkPMRmNXBcKM6WIUuwDhLO40Tx8xmB6UQXXLMyi3BlLACp4Fvh3Sfunyy3R0clwkDfbp6v4B36YXp3ENVLYMY2g8V8huGVQvCpfpY93rsfYU2OeR+3ewHR+GTRC/7Ymc5eKqcdry2rbKxeJrivLwW/uURLyDkBvc6BsN1QzTFK4O3FUes9DDB65rH3MTahsrUsJ6Ru3sMuvWnMr/eAodgJ7s/4w5sX2jbf2TjV4NUUsxmtXT8YpSBi3aG+BOBAmxzQeVQ42IkHPSSlQh9ouLF/zZ32R3zrHRI3SBDNmG1qp8TORvxaB4/3ehv1swDoLOzZTwQq0qfYUMXy0AuH14UscSkCGs/bEJVTnTWXuwBjRMKbUysa6ODA+A09Pok8VqiXS+39y1wz/MqrY7VtcSQAjfpZOqCjAvXHF0KkSTUXVLJiFXNwWr5Fxh27ggLqj6laAIqPoAIaBKY8SO2jaJB9C+htvIXHrJTg3xJfOfmBjByxHDyy+x0Jr1ZkPZbi3A97/IS0FvVMQfP1rj701ZslJKs/M+3Ll/HWtjZnJX8Cg4SBnaLl+fjoJdIEcXrIYgEZUjjfjL3hWRxYb0BLTWD678="
    on_success: always
    on_failure: always

addons:
  firefox: "45.0"
